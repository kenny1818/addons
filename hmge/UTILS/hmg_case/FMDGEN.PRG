#Include "hmg.ch"

Function Fmd_GEN()

   use _fmd_apl
   if reccount() = 0
      use
      msginfo('Nothing, first create Form')
      return 
   endif
   use

	DEFINE WINDOW FmdGenForm ;
		AT 0,0 ;
		WIDTH 400 ;  
		HEIGHT 300 ;
		TITLE 'Generate Master/Detail program' ;
		MODAL ;      
		ON INIT OpenTablesMD1()
	
   ON KEY ESCAPE ACTION FmdGenForm.Release
   
		@ 10, 10 COMBOBOX Combo_1 ;
			ITEMSOURCE _fmd_APL->FORMNAME ;
			VALUE 1 ;
			WIDTH 200 HEIGHT 100 ;
			FONT "Arial" SIZE 10 ; 
			TOOLTIP "Form" 

	   @ 150, 150 BUTTON REPORT_111 ; 
   		CAPTION " Create Form " ;
		   WIDTH 100 ;
		   ACTION fmd_genn() 

	END WINDOW		 

	CENTER WINDOW   FmdGenForm
	ACTIVATE WINDOW FmdGenForm

Return
*:------------------------------------------
Procedure OpenTablesMD1()

	Use _fmd_apl index _fmd_apl New
   
Return
*:-------------------------------------------
FUNCTION fmd_GENN 

_key := FmdGenForm.Combo_1.Value
_sums := 0
_statfld := 0
_sumformat := 0

dbcloseall()

select 2
use _fmd_apl
go _key

_table := alltrim(formname)

select 4
use _fmd_fld
set filter to formname = _table
dbgotop()
count to _polja for formname = _table
copy to _temp

*** ima li SUM polja

dbgotop()
do while .not. eof()

   if fldatr5
      _sums++
	  _sumformat = alltrim(fldpict)
   endif
   
   if block=1 .and. fldname = 'STATUS'
      _statfld++
   endif
  
dbskip()
enddo

select 5
use _fmd_rel 
set filter to formname = _table
dbgotop()
_set_qry = alltrim(field1) + ' != 0'

count to _keys for formname = _table

select 2
locate for formname = _table
_xx = apl_num

_nn = alltrim(str(_xx))
_nnn = sbrand()

_fmd_prg = 'edmd_' + _nn + '.prg'

select 1
use _fmd_dbf
set filter to dbfname = _table
dbgotop()

tek_red = 0

set device to printer
set printer to &_fmd_prg

@ tek_red, 0 say '/*'
tek_red++
@ tek_red, 0 say ' * This program is generated by HMGCASE'
tek_red++
@ tek_red, 0 say ' * developed by Dragan Cizmarevic < dragancesu(at)gmail.com > '
tek_red++
@ tek_red, 0 say ' * created at ' + dtoc(date()) + ' ' + time()
tek_red++
@ tek_red, 0 say ' */'
tek_red++

@ tek_red, 0 say '#include <hmg.ch>'
tek_red++

tek_red++
@ tek_red, 0 say 'STATIC aGrid := {} , _qry_exp := "' + _set_qry + '"'
tek_red++

tek_red++
@ tek_red, 0 say 'PROCEDURE MAIN // for test, usually edit_' + alltrim(_table)
tek_red++

if _statfld > 0
tek_red++
@ tek_red, 0 say 'PRIVATE bColor := { || if ( Status == "K" , { 144,238,144 } , { 245,245,245 } ) }'
tek_red++
endif

tek_red++
@ tek_red, 0 say '   set navigation extended    // for test  '
tek_red++
tek_red++
@ tek_red, 0 say '   set date german            // for test  '
tek_red++
@ tek_red, 0 say '   set century on             // for test  '
tek_red++
tek_red++
@ tek_red, 0 say '   set procedure to open_dbf  // for test  '
tek_red++
@ tek_red, 0 say '   set procedure to open_ntx  // for test  '
tek_red++
@ tek_red, 0 say '   set procedure to Use_dbf   // for test  '
tek_red++
tek_red++
@ tek_red, 0 say '   set procedure to sbr_lov   // for test  '
tek_red++
tek_red++
@ tek_red, 0 say '   open_dbf()                 // for test  '
tek_red++
@ tek_red, 0 say '   open_ntx()                 // for test  '
tek_red++


tek_red++
@ tek_red, 0 say '   open_' + _nnn + '()'
tek_red++

tek_red++
@ tek_red, 0 say '   DEFINE WINDOW MD_Form_' + _nn + ' ;'
tek_red++
@ tek_red, 0 say '      AT 10,10 ;'
tek_red++
@ tek_red, 0 say '      WIDTH 1000 ;'
tek_red++
@ tek_red, 0 say '      HEIGHT 700 ;'
tek_red++
@ tek_red, 0 say '      TITLE "Master / Detail Form" ;'
tek_red++
@ tek_red, 0 say '      MAIN ; // for test, usually MODAL ;'  
tek_red++
@ tek_red, 0 say '      ON INIT RefreshWin_' + _nnn + '(1) ;'
tek_red++
@ tek_red, 0 say '      ON RELEASE dbcloseall() ;'
tek_red++
@ tek_red, 0 say '      BACKCOLOR { 240, 240, 240 }'
tek_red++

tek_red++
@ tek_red, 0 say '      ON KEY ESCAPE ACTION MD_Form_' + _nn + '.Release'
tek_red++

tek_red++
@ tek_red, 0 say '      ON KEY F2 ACTION Mas_edit_' + _nn + '("F")'
tek_red++
@ tek_red, 0 say '      ON KEY F4 ACTION Mas_edit_' + _nn + '("E")'
tek_red++
@ tek_red, 0 say '      ON KEY F6 ACTION Mas_edit_' + _nn + '("N")'
tek_red++
@ tek_red, 0 say '      ON KEY F8 ACTION Mas_edit_' + _nn + '("D")'
tek_red++
@ tek_red, 0 say '      ON KEY F9 ACTION PrintData_' + _nnn + '()'
tek_red++
@ tek_red, 0 say '      ON KEY F10 ACTION MD_Form_' + _nn + '.Release'
tek_red++
@ tek_red, 0 say '      ON KEY F12 ACTION Det_Edit_' + _nn + '("N")'
tek_red++
@ tek_red, 0 say '      ON KEY F11 ACTION Det_Edit_' + _nn + '("D")'
tek_red++


tek_red++
@ tek_red, 0 say '      DEFINE STATUSBAR FONT "Arial" SIZE 12'
tek_red++
@ tek_red, 0 say '         STATUSITEM "Master / Detail"'
tek_red++
@ tek_red, 0 say '      END STATUSBAR'
tek_red++

tek_red++
@ tek_red, 0 say '      DEFINE TOOLBAR ToolBar_' + _nn + ' BUTTONSIZE 50,50 IMAGESIZE 24,24 FLAT BORDER '
tek_red++

tek_red++
@ tek_red, 0 say '      BUTTON FIND_' + _nnn + ' ; '
tek_red++
@ tek_red, 0 say '         CAPTION "[F2] Find" ; '
tek_red++
@ tek_red, 0 say '         PICTURE "frm_find.bmp" ; '
tek_red++
@ tek_red, 0 say '         ACTION Mas_edit_' + _nn + '("F") '
tek_red++

tek_red++
@ tek_red, 0 say '      BUTTON EDIT_' + _nnn + ' ;'
tek_red++
@ tek_red, 0 say '         CAPTION "[F4] Edit" ;'
tek_red++
@ tek_red, 0 say '         PICTURE "frm_edit.bmp" ;'
tek_red++
@ tek_red, 0 say '         ACTION Mas_edit_' + _nn + '("E")'
tek_red++

tek_red++
@ tek_red, 0 say '      BUTTON NEW_' + _nnn + ' ;'
tek_red++
@ tek_red, 0 say '         CAPTION "[F6] New" ;'
tek_red++
@ tek_red, 0 say '         PICTURE "frm_new.bmp" ;'
tek_red++
@ tek_red, 0 say '         ACTION Mas_edit_' + _nn + '("N")'
tek_red++

tek_red++
@ tek_red, 0 say '      BUTTON DELETE_' + _nnn + ' ;'
tek_red++
@ tek_red, 0 say '         CAPTION "[F8] Delete" ;'
tek_red++
@ tek_red, 0 say '         PICTURE "frm_delete.bmp" ;'
tek_red++
@ tek_red, 0 say '         ACTION Mas_edit_' + _nn + '("D")'
tek_red++

tek_red++
@ tek_red, 0 say '      BUTTON PRINT_' + _nnn + ' ;'
tek_red++
@ tek_red, 0 say '         CAPTION "[F9] Print" ;'
tek_red++
@ tek_red, 0 say '         PICTURE "frm_print.bmp" ;'
tek_red++
@ tek_red, 0 say '         ACTION PrintData_' + _nnn + '()'
tek_red++

tek_red++
@ tek_red, 0 say '      BUTTON EXIT_' + _nnn + ' ;'
tek_red++
@ tek_red, 0 say '         CAPTION "[F10] Exit" ;'
tek_red++
@ tek_red, 0 say '         PICTURE "frm_exit.bmp" ;'
tek_red++
@ tek_red, 0 say '         ACTION MD_Form_' + _nn + '.Release'
tek_red++

tek_red++
@ tek_red, 0 say '      // add users functions in Toolbar '
tek_red++
@ tek_red, 0 say '      /*'

tek_red++
@ tek_red, 0 say '      BUTTON FN1_' + _nnn + ' ;'
tek_red++
@ tek_red, 0 say '         CAPTION "Fn(1)" ;'
tek_red++
@ tek_red, 0 say '         PICTURE "frm_fn.bmp" ;'
tek_red++
@ tek_red, 0 say '         ACTION nil'
tek_red++

tek_red++
@ tek_red, 0 say '      BUTTON FN2_' + _nnn + ' ;'
tek_red++
@ tek_red, 0 say '         CAPTION "Fn(2)" ;'
tek_red++
@ tek_red, 0 say '         PICTURE "frm_fn.bmp" ;'
tek_red++
@ tek_red, 0 say '         ACTION nil'
tek_red++

tek_red++
@ tek_red, 0 say '      BUTTON FN3_' + _nnn + ' ;'
tek_red++
@ tek_red, 0 say '         CAPTION "Fn(3)" ;'
tek_red++
@ tek_red, 0 say '         PICTURE "frm_fn.bmp" ;'
tek_red++
@ tek_red, 0 say '         ACTION nil'
tek_red++

@ tek_red, 0 say '      */'
tek_red++

tek_red++
@ tek_red, 0 say '      END TOOLBAR'
tek_red++

tek_red++
@ tek_red, 0 say '      PaintDisplay_' + _nnn + '()'
tek_red++

_head = '"Recno",'
_fild = ''
_wids = '0,'
_ima = 0
_just = '1,'

select 4
dbgotop()
do while .not. eof()

if block != 2
   dbskip()
   loop
endif

_memvar = .f.
if dbfname = '$'
   _memvar = .t.
endif

if fldatr1 .or. _memvar

   if _memvar 

      _head = _head + '"$' + alltrim(fldname) + '",' 
      _fild = _fild + '"' + alltrim(fldname) + '",' 
      _wids = _wids + alltrim(str(fldlen*10)) + ','
      _ima++

   else

      _head = _head + '"' + alltrim(fldlabel) + '",' 
      _fild = _fild + '"' + alltrim(fldname) + '",' 
      _siri1 = max( len(alltrim(fldlabel)), len(alltrim(fldname)) )
      _siri = max ( _siri1, fldlen)
      _wids = _wids + alltrim(str(_siri*10+10)) + ','
      _ima++

   endif
   
else
   dbskip()
   loop
endif

if fldtype = 'N'
   _just = _just + '1,'
else
   _just = _just + '0,'
endif

dbskip()
enddo

   _duzh = len(_head)
   _duzw = len(_wids)
   _duzj = len(_just)
   
   _head = substr(_head,1,_duzh-1)
   _wids = substr(_wids,1,_duzw-1)   
   _just = substr(_just,1,_duzj-1)   

tek_red++
@ tek_red, 0 say '      @ 250,10 GRID MD_Grid_' + _nn + ' ;'
tek_red++
@ tek_red, 0 say '         WIDTH 950 ;'
tek_red++
@ tek_red, 0 say '         HEIGHT 300 ;'
tek_red++
@ tek_red, 0 say '         HEADERS { ' + _head + ' } ;'
tek_red++
@ tek_red, 0 say '         WIDTHS { ' + _wids + ' } ;'
tek_red++
@ tek_red, 0 say '         FONT "Arial" ;'
tek_red++
@ tek_red, 0 say '         SIZE 10 ;'
tek_red++
@ tek_red, 0 say '         ON DBLCLICK Det_Edit_' + _nn + '("E") ;'
tek_red++
@ tek_red, 0 say '         JUSTIFY { ' + _just + ' } '
tek_red++
 
if _sums > 0

tek_red++
@ tek_red, 0 say '      @ 560, 500 LABEL lSum value "SUM"'
for i = 1 to _sums 
   _col = 500 + 100 * i
   tek_red++
   @ tek_red, 0 say '      @ 560, ' + alltrim(str(_col)) + ' TEXTBOX nSum_' + alltrim(str(i)) + ' WIDTH 95 NUMERIC INPUTMASK "' + _sumformat + '"'
next
tek_red++
endif

tek_red++
@ tek_red, 0 say '      @ 600, 750 BUTTON cmd2New CAPTION "[F12]" PICTURE "frm_plus.bmp" LEFT ACTION Det_Edit_' + _nn + '("N") WIDTH 80 HEIGHT 25 '
tek_red++
@ tek_red, 0 say '      @ 600, 850 BUTTON cmd2Del CAPTION "[F11]" PICTURE "frm_minus.bmp" LEFT ACTION Det_Edit_' + _nn + '("D") WIDTH 80 HEIGHT 25 '
tek_red++

tek_red++
@ tek_red, 0 say '   END WINDOW'
tek_red++

tek_red++
@ tek_red, 0 say '   ACTIVATE WINDOW MD_Form_' + _nn
tek_red++

tek_red++
@ tek_red, 0 say 'RETURN'

tek_red++
@ tek_red, 0 say '*:---------------------------------------------*'

tek_red++
@ tek_red, 0 say 'FUNCTION open_' + _nnn + '()'
tek_red++

_setrel := 0

select 4
index on formname+valid_dbf to _temp unique
dbgotop()
do while .not. eof()

if !fldatr8
   dbskip()
   loop
endif

tek_red++
@ tek_red, 0 say '   use_' + alltrim(valid_dbf) + '()'

dbskip()
enddo

set index to _fmd_fld

select 1
tek_red++
@ tek_red, 0 say '   use_' + alltrim(dbfname2) + '() '

select 4
dbgotop()
do while .not. eof()

   if block != 2
      dbskip()
      loop
   endif

   if !empty(valid_dbf) 
      _setrel++ 
      tek_red++
      @ tek_red, 0 say '   set relation to ' + alltrim(fldname) + ' into ' + alltrim(valid_dbf) + if(_setrel>1,' ADDITIVE ','')
   endif

dbskip()
enddo

select 1
tek_red++
@ tek_red, 0 say '   use_' + alltrim(dbfname) + '() ' 

select 4
dbgotop()
do while .not. eof()

   if block != 1
      dbskip()
      loop
   endif

   if !empty(valid_dbf) 
      _setrel++ 
      tek_red++
      @ tek_red, 0 say '   set relation to ' + alltrim(fldname) + ' into ' + alltrim(valid_dbf) + if(_setrel>1,' ADDITIVE ','')
   endif

dbskip()
enddo

if _keys > 0

      tek_red++
      select 5
      dbgotop()     
      tek_red++
      @ tek_red, 0 say '   SET FILTER TO ' + chr(38) + '_qry_exp'
      tek_red++
      @ tek_red, 0 say '   DBGOTOP()'
      tek_red++   

endif 

tek_red++
@ tek_red, 0 say 'RETURN'

tek_red++
@ tek_red, 0 say '*:---------------------------------------------*'
tek_red++
@ tek_red, 0 say 'FUNCTION PaintDisplay_' + _nnn + '()'
tek_red++

select 3
use _temp

*** browse 

_head = ''
_widt = ''
_fiel = ''
_just = ''
_polja = 0

select 4
dbgotop()
do while .not. eof()

if block != 1
   dbskip()
   loop
endif

if dbfname = '$'
   _polje = fldname
   _ima = .f.
   _lenn = alltrim(str(fldlen * 10))  
   
   select 3
   dbgotop()
   do while .not. eof()
  
   if block != 1
      dbskip()
      loop
   endif  
   
   if _polje =  valid_dsp
      
      _ima = .t.  
      _labell = '$' + alltrim(_polje)
      
      _poljee = alltrim(valid_dbf) + '->' + alltrim(valid_fld)
     
      _head = _head + chr(34) + _labell + chr(34) + ','
      _widt = _widt + _lenn + ','
      _fiel = _fiel + chr(34) + _poljee + chr(34) + ','
      _just = _just + '0,'
      _polja++     
	  
   endif   
   
   dbskip()
   enddo

else

   _head = _head + chr(34) + alltrim(fldlabel) + chr(34) + ','
   _widt = _widt + alltrim(str(fldlen*10+10)) + ','
   _fiel = _fiel + chr(34) + alltrim(fldname) + chr(34) + ','
   _polja++
   
   if fldtype = 'N'
      _just = _just + '1,'
   else
      _just = _just + '0,'
   endif
  
endif

_dynamic = 'DYNAMICBACKCOLOR { ' 
for i = 1 to _polja-1 
   _dynamic = _dynamic + 'bColor, '
next
_dynamic = _dynamic + 'bColor } ;'

select 4
dbskip()
enddo

   _duzh = len(_head)
   _duzw = len(_widt)
   _duzf = len(_fiel)
   _duzj = len(_just)
   
   _head = substr(_head,1,_duzh-1)
   _widt = substr(_widt,1,_duzw-1)
   _fiel = substr(_fiel,1,_duzf-1)   
   _just = substr(_just,1,_duzj-1)   

tek_red++
@ tek_red, 0 say '   @ 90,10 BROWSE Browse_' + _nn + ' ; '
tek_red++
@ tek_red, 0 say '      OF MD_Form_' + _nn + ' ; '
tek_red++
@ tek_red, 0 say '      WIDTH 950 ; '
tek_red++
@ tek_red, 0 say '      HEIGHT 130 ; '
tek_red++
@ tek_red, 0 say '      FONT "Arial" ; '
tek_red++
@ tek_red, 0 say '      SIZE 10 ; '
tek_red++
@ tek_red, 0 say '      HEADERS { ' + _head + ' } ; '
tek_red++
@ tek_red, 0 say '      WIDTHS { ' +  _widt + ' } ; '
tek_red++
@ tek_red, 0 say '      WORKAREA ' + _table + ' ; '
tek_red++
@ tek_red, 0 say '      FIELDS { ' + _fiel + ' } ; '
tek_red++

if _statfld > 0
@ tek_red, 0 say '      ' + _dynamic
tek_red++
endif

@ tek_red, 0 say '      ON CHANGE RefreshWin_' + _nnn + '() ; '
tek_red++
@ tek_red, 0 say '      ON DBLCLICK Mas_Edit_' + _nn + '("E") ; '
tek_red++
@ tek_red, 0 say '      JUSTIFY { ' + _just + ' } '
tek_red++

tek_red++
@ tek_red, 0 say 'RETURN 0'

tek_red++
@ tek_red, 0 say '*:---------------------------------------------*'

tek_red++
@ tek_red, 0 say 'FUNCTION RefreshWin_' + _nnn + '( _step )'
tek_red++

tek_red++
@ tek_red, 0 say '   IF _step = 1'
tek_red++
@ tek_red, 0 say '      DbGoTop()'
tek_red++
@ tek_red, 0 say '      MD_Form_' + _nn + '.Browse_' + _nn + '.Refresh'
tek_red++
@ tek_red, 0 say '   ENDIF'
tek_red++

tek_red++
@ tek_red, 0 say '   _recno := MD_Form_' + _nn + '.Browse_' + _nn + '.Value'
tek_red++
@ tek_red, 0 say '   GO _recno '
tek_red++


select 5
dbgotop()
do while .not. eof()

   tek_red++
   @ tek_red, 0 say '   _key' + alltrim(str(seq)) + ' := ' + alltrim(dbf1) + '->' + alltrim(field1) 

dbskip()
enddo
tek_red++

tek_red++
@ tek_red, 0 say '   aGrid := {}'
tek_red++

for i = 1 to _sums
   tek_red++
   @ tek_red, 0 say '   Sum_' + alltrim(str(i)) + ' := 0'
next

tek_red++
select 1
@ tek_red, 0 say '   SELECT ' + dbfname2
tek_red++
@ tek_red, 0 say '   dbgotop()'
tek_red++
@ tek_red, 0 say '   DO WHILE .NOT. EOF()'

_keykey = ''
_imaima = 0
if _keys > 0

select 5
dbgotop()
do while .not. eof()

   if _imaima > 0
      _keykey = _keykey + ' .or. '
   endif

   _keykey = _keykey + '_key' + alltrim(str(seq)) + ' != ' + alltrim(dbf2) + '->' + alltrim(field2)
   _imaima++
   
   dbskip()
enddo

tek_red++
@ tek_red, 0 say '      IF ' + _keykey 
tek_red++
@ tek_red, 0 say '         DBSKIP()'
tek_red++
@ tek_red, 0 say '         LOOP'
tek_red++
@ tek_red, 0 say '      ENDIF'

endif

_fild = 'str(recno()),' 

select 4
dbgotop()
do while .not. eof()

   if block != 2
      dbskip()
      loop
   endif
   
   _memvar = .f.
   if dbfname = '$'
      _polje = fldname 
      _memvar = .t.
      
      select 3
      dbgotop()
      do while .not. eof()
      
         if block != 2
            dbskip()
            loop
         endif
      
         if valid_dsp != _polje
            dbskip()
            loop
         endif
           
         _fldfld = alltrim(valid_dbf)+'->'+alltrim(valid_fld)
        
      dbskip()
      enddo
            
   endif
  
   select 4
   if fldatr1 .or. _memvar
   else
      dbskip()
	   loop
   endif
  
   if _memvar
  
      if empty(_fldfld)
         msginfo('Check Validate fields')
         dbcloseall()
         return 
      endif
  
     _fild = _fild + alltrim(_fldfld) + ',' 
  
   else
    
      if fldtype = 'N'
         _fild = _fild + 'str(' + alltrim(fldname) + '),' 
      elseif fldtype = 'D'
         _fild = _fild + 'dtoc(' + alltrim(fldname) + '),' 
      else
         _fild = _fild + alltrim(fldname) + ',' 
      endif

  endif 
 
   select 4
   dbskip()
enddo

   _len  = len( _fild )
   _fild1 = substr( _fild, 1, _len-1)
   
tek_red++
@ tek_red, 0 say '      Aadd(aGrid, {' + _fild1 + '})'

if _sums > 0
_i := 0
select 4
dbgotop()
do while .not.eof()

   if block != 2
      dbskip()
      loop
   endif

   if !fldatr5
      dbskip()
      loop
   endif

   _i++
   tek_red++
   @ tek_red, 0 say '      Sum_' + alltrim(str(_i)) + ' = Sum_' + alltrim(str(_i)) + ' + ' + alltrim(fldname)

dbskip()
enddo
endif

tek_red++
@ tek_red, 0 say '      DBSKIP()'
tek_red++
@ tek_red, 0 say '   ENDDO'

for i = 1 to _sums

tek_red++
@ tek_red, 0 say '   MD_Form_' + _nn + '.nSum_' + alltrim(str(i)) + '.Value := Sum_' + alltrim(str(i))

next

tek_red++
@ tek_red, 0 say '   MD_Form_' + _nn + '.MD_Grid_' + _nn + '.DeleteAllItems()'
tek_red++
@ tek_red, 0 say '   FOR i = 1 to LEN(aGrid)'
tek_red++
@ tek_red, 0 say '      MD_Form_' + _nn + '.MD_Grid_' + _nn + '.AddItem(aGrid[i])'
tek_red++
@ tek_red, 0 say '   NEXT'

select 1
tek_red++
@ tek_red, 0 say '   SELECT ' + dbfname
tek_red++

tek_red++
@ tek_red, 0 say 'RETURN 0'

tek_red++
@ tek_red, 0 say '*:---------------------------------------------*'

tek_red++
@ tek_red, 0 say 'FUNCTION Exit_' + _nnn + '()'
tek_red++

tek_red++
@ tek_red, 0 say '   DbCloseAll()'
tek_red++
@ tek_red, 0 say '   MD_Form_' + _nn + '.Release'
tek_red++
  
tek_red++
@ tek_red, 0 say 'RETURN 0'

tek_red++
@ tek_red, 0 say '*:*********************************************'
tek_red++
@ tek_red, 0 say '*                                             *'
tek_red++
@ tek_red, 0 say '* master block                                *'
tek_red++
@ tek_red, 0 say '*                                             *'
tek_red++
@ tek_red, 0 say '*:*********************************************'
tek_red++
@ tek_red, 0 say 'FUNCTION Mas_Edit_' + _nn + '( _do_it  )'
tek_red++

tek_red++
@ tek_red, 0 say '   PRIVATE _action := _do_it, _rec_no := recno()'
tek_red++

if _statfld> 0
 tek_red++
@ tek_red, 0 say '     if status = "K" .and. ( _action = "E" .or. _action = "D" )'
tek_red++
@ tek_red, 0 say '         msginfo("Record LOCKED, no change!") '
tek_red++
@ tek_red, 0 say '         return '
tek_red++
@ tek_red, 0 say '      endif '
tek_red++
endif

tek_red++
@ tek_red, 0 say '      IF _action = "D"'
tek_red++
@ tek_red, 0 say '         Delete1Rec_' + _nn + '()'
tek_red++
@ tek_red, 0 say '         RETURN'
tek_red++
@ tek_red, 0 say '      ENDIF'
tek_red++

tek_red++
@ tek_red, 0 say '   DEFINE WINDOW Mas_Form_' + _nn + ' ;'
tek_red++
@ tek_red, 0 say '      AT 0,0 ;'
tek_red++
@ tek_red, 0 say '      WIDTH 600 ;'
tek_red++
@ tek_red, 0 say '      HEIGHT 700 ;'
tek_red++
@ tek_red, 0 say '      TITLE "Edit Master Record" ;'
tek_red++
@ tek_red, 0 say '      MODAL ;'
tek_red++

tek_red++
@ tek_red, 0 say '      ON KEY ESCAPE ACTION Mas_Form_' + _nn + '.Release'
tek_red++

tek_red++
@ tek_red, 0 say '      @ 580, 270 BUTTON QUERY_' + _nnn + '; '
tek_red++
@ tek_red, 0 say '         CAPTION "Query" ; '
tek_red++
@ tek_red, 0 say '         PICTURE "frm_find.bmp" LEFT ;'
tek_red++
@ tek_red, 0 say '         ACTION Query1Rec_' + _nnn + '() ;'
tek_red++
@ tek_red, 0 say '         WIDTH 100 ;'
tek_red++
@ tek_red, 0 say '         HEIGHT 40'
tek_red++

tek_red++
@ tek_red, 0 say '      @ 580, 50 BUTTON SAVE_' + _nnn + '; '
tek_red++
@ tek_red, 0 say '         CAPTION "Save" ; '
tek_red++
@ tek_red, 0 say '         PICTURE "frm_ok.bmp" LEFT ;'
tek_red++
@ tek_red, 0 say '         ACTION Save1Record_' + _nnn + '() ;'
tek_red++
@ tek_red, 0 say '         WIDTH 100 ;'
tek_red++
@ tek_red, 0 say '         HEIGHT 40'
tek_red++

tek_red++
@ tek_red, 0 say '      @ 580, 160 BUTTON CANCEL_' + _nnn + '; '
tek_red++
@ tek_red, 0 say '         CAPTION "Cancel" ; '
tek_red++
@ tek_red, 0 say '         PICTURE "frm_cancel.bmp" LEFT ;'
tek_red++
@ tek_red, 0 say '         ACTION Cancel1Edit_' + _nnn + '() ;'
tek_red++
@ tek_red, 0 say '         WIDTH 100 ;'
tek_red++
@ tek_red, 0 say '         HEIGHT 40'
tek_red++

tek_red++
@ tek_red, 0 say '      Paint1Record_' + _nnn + '()'
tek_red++
@ tek_red, 0 say '      Disable1Record_' + _nnn + '()'
tek_red++
@ tek_red, 0 say '      Load1Data_' + _nnn + '()'
tek_red++
@ tek_red, 0 say '      Enable1Record_' + _nnn + '()'
tek_red++

tek_red++
@ tek_red, 0 say '   END WINDOW '
tek_red++

tek_red++
@ tek_red, 0 say '   CENTER WINDOW Mas_Form_' + _nn
tek_red++

tek_red++
@ tek_red, 0 say '   ACTIVATE WINDOW Mas_Form_' + _nn
tek_red++

tek_red++
@ tek_red, 0 say 'RETURN'

tek_red++
@ tek_red, 0 say '*:---------------------------------------------*'
tek_red++
@ tek_red, 0 say 'FUNCTION Disable1Record_' + _nnn + '()'
tek_red++

select 4
dbgotop()
do while .not. eof()

if block != 1
   dbskip()
   loop
endif

_len = len(alltrim(fldname))
_space = space ( 12 - _len )
_tip = '.m'

if dbfname = '$'
   _tip = '.d'
endif

tek_red++
@ tek_red, 0 say '   Mas_Form_' + _nn + _tip + alltrim(fldname) + '.Enabled' + _space + ':= .F.' 

dbskip()
enddo
tek_red++

tek_red++
@ tek_red, 0 say '   IF _action != "F"'
tek_red++
@ tek_red, 0 say '      Mas_Form_' + _nn + '.QUERY_' + _nnn + '.Visible := .F.'
tek_red++
@ tek_red, 0 say '      Mas_Form_' + _nn + '.QUERY_' + _nnn + '.Enabled := .F.'
tek_red++
@ tek_red, 0 say '   ENDIF '
tek_red++

tek_red++
@ tek_red, 0 say 'RETURN'
tek_red++
@ tek_red, 0 say '*:---------------------------------------------*'
tek_red++
@ tek_red, 0 say 'FUNCTION Enable1Record_' + _nnn + '()'
tek_red++

_prvi = ''

select 4
dbgotop()
do while .not. eof()

if block != 1
   dbskip()
   loop
endif

if dbfname = '$'
   dbskip()
   loop
endif

_len = len(alltrim(fldname))
_space = space ( 12 - _len )
if fldatr4
   _set = '.T.'
else
   _set = '.F.'
endif

if empty(_prvi)
   _prvi = alltrim(fldname)
endif

tek_red++
@ tek_red, 0 say '   Mas_Form_' + _nn + '.m' + alltrim(fldname) + '.Enabled' + _space + ':= ' + _set

dbskip()
enddo
tek_red++

tek_red++
@ tek_red, 0 say '   IF _action = "F"'
tek_red++
@ tek_red, 0 say '      Mas_Form_' + _nn + '.SAVE_' + _nnn + '.Visible   := .F.'
tek_red++
@ tek_red, 0 say '      Mas_Form_' + _nn + '.SAVE_' + _nnn + '.Enabled   := .F.'
tek_red++
@ tek_red, 0 say '      Mas_Form_' + _nn + '.CANCEL_' + _nnn + '.Visible := .F.'
tek_red++
@ tek_red, 0 say '      Mas_Form_' + _nn + '.CANCEL_' + _nnn + '.Enabled := .F.'
tek_red++
@ tek_red, 0 say '   ENDIF '
tek_red++

tek_red++
@ tek_red, 0 say '   Mas_Form_' + _nn + '.m' + _prvi + '.SetFocus'
tek_red++

tek_red++
@ tek_red, 0 say 'RETURN'

tek_red++
@ tek_red, 0 say '*:---------------------------------------------*'

tek_red++
@ tek_red, 0 say 'FUNCTION Paint1Record_' + _nnn + '()'
tek_red++

*** labels 
_row = 100
_col = 20

select 4
dbgotop()
do while .not. eof()

if block != 1
   dbskip()
   loop
endif

if dbfname = '$'
   dbskip()
   loop
endif

_len = len(alltrim(fldname))
_space = space( 12 - _len )

*_roww = _row
*_coll = _col
_roww = fldrow
_coll = fldcol

_prikaz = .f.

if fldatr2 .or. fldatr8
   _prikaz = .t.
else
   *_roww = 999
   *_coll = 999
   dbskip()
   loop
endif

tek_red++
@ tek_red, 0 say '   @ ' + str(_roww,3) + ', ' + str(_coll,3) + ' LABEL l' + alltrim(fldname) + _space + ' VALUE "' + alltrim(fldlabel) + '"'

if _prikaz
   _row = _row + 30
endif

select 4
dbskip()
enddo

tek_red++

*** texbox

_row = 100
_col = 120
_roww = 0
_coll = 0
_r = 999
_c = 999

select 4
dbgotop()
do while .not. eof()

if block != 1
   dbskip()
   loop
endif

_tip = 'm'
_widt = ''
_mask = ''
_format = ''
_valid = ''
_fldlen = fldlen

if _fldlen < 5
   _fldlen++
endif

if fldtype = 'N'
   _widt = ' WIDTH ' + alltrim(str(_fldlen * 10))
   _mask = ' NUMERIC '
   _format = ' INPUTMASK "' + alltrim(fldpict) + '"'
endif

if fldtype = 'D'
   _widt = ''
   _mask = ' DATE '
   _format = ''
endif

if fldtype = 'C'
   _widt = ' WIDTH ' + alltrim(str(_fldlen * 10))
   _mask = ''
   _pict = strtran(fldpict,'X','!')
   _format = ' INPUTMASK "' + alltrim(_pict) + '"'
   if empty(_pict)
      _format = ''
   endif
endif

_len = len(alltrim(fldname))
_space = space( 12 - _len )

if dbfname = '$'
   _tip = 'd'
   _format = ''
   _rr = _roww
   _rc = 200
endif

if fldatr8
   _valid = ' on enter valid_' + _nn + '_A_' + alltrim(str(fldseq)) + '( "E" ) '
   _valid = _valid + ' on lostfocus valid_' + _nn + '_A_' + alltrim(str(fldseq)) + '( "F" ) '
endif

_prikaz = .f.

if fldatr2 .or. fldatr8
   _prikaz = .t.
   _roww = _row
   _coll = _col
else
   _roww = _r++
   _coll = _c++
endif

if _tip = 'd'
   _roww = _rr
   _coll = _rc
endif

_roww = fldrow
_coll = fldcol+100

tek_red++
@ tek_red, 0 say '   @ ' + str(_roww,4) + ', ' + str(_coll,4) + ' TEXTBOX ' + _tip + alltrim(fldname) + _space + _widt + _mask + _format + _valid 

if _prikaz 
   _row = _row + 30
endif

select 4
dbskip()
enddo

tek_red++
tek_red++
@ tek_red, 0 say 'RETURN 0'
tek_red++
@ tek_red, 0 say '*:---------------------------------------------*'

tek_red++
@ tek_red, 0 say 'FUNCTION Load1Data_' + _nnn + '()'
tek_red++

select 1
tek_red++
@ tek_red, 0 say '   SELECT ' + dbfname
tek_red++

_dbfname := dbfname

tek_red++
@ tek_red, 0 say '   IF _action = "N" '

select 4
dbgotop()
do while .not. eof()

if block != 1
   dbskip()
   loop
endif

if dbfname = '$'
   dbskip()
   loop
endif

_len = len(alltrim(fldname))
_space = space ( 12 - _len )
_default = alltrim(flddef)

if at('space',_default) > 0
   _default = &flddef
endif

if fldtype = 'C'
   _default = chr(34) + _default + chr(34)
endif
*if fldtype = 'D'
*   _default = 'ctod("")'
*endif

tek_red++
@ tek_red, 0 say '      Mas_Form_' + _nn + '.m' + alltrim(FLDNAME) + '.Value ' + _space  + ' := ' + _default

dbskip()
enddo

tek_red++
tek_red++
@ tek_red, 0 say '   ELSEIF _action = "F"'

select 4
dbgotop()
do while .not. eof()

if block != 1
   dbskip()
   loop
endif

if dbfname = '$'
   dbskip()
   loop
endif

_len = len(alltrim(fldname))
_space = space ( 12 - _len )
_default = alltrim(flddef)

if at('space',_default) > 0
   _default = &flddef
endif

if fldtype = 'N'
   _default = '0'
endif
if fldtype = 'C'
   _default = chr(34) + chr(34)
endif
if fldtype = 'D'
   _default = 'ctod("")'
endif

tek_red++
@ tek_red, 0 say '      Mas_Form_' + _nn + '.m' + alltrim(FLDNAME) + '.Value ' + _space  + ' := ' + _default

dbskip()
enddo

tek_red++
tek_red++
@ tek_red, 0 say '   ELSE'

tek_red++
@ tek_red, 0 say '      GOTO _rec_no'

select 4
dbgotop()
do while .not. eof()

if block != 1
   dbskip()
   loop
endif

if dbfname = '$'
   dbskip()
   loop
endif

_len = len(alltrim(fldname))
_space = space ( 12 - _len )

tek_red++
@ tek_red, 0 say '      Mas_Form_' + _nn + '.m' + alltrim(FLDNAME) + '.Value ' + _space + ' := ' + alltrim(dbfname) + '->' + alltrim(fldname)

dbskip()
enddo

select 4
dbgotop()
do while .not. eof()

if block != 1
   dbskip()
   loop
endif

if !fldatr8
   dbskip()
   loop
endif

tek_red++
@ tek_red, 0 say '      SELECT ' + alltrim(valid_dbf)
tek_red++
@ tek_red, 0 say '      SEEK Mas_Form_' + _nn + '.m' + alltrim(fldname) + '.Value'
tek_red++
@ tek_red, 0 say '      IF FOUND()'
tek_red++
@ tek_red, 0 say '         Mas_Form_' + _nn + '.d' + alltrim(valid_dsp) + '.Value := ' + alltrim(valid_dbf) + '->' + alltrim(valid_fld)
tek_red++
@ tek_red, 0 say '         SELECT ' + _dbfname
tek_red++
@ tek_red, 0 say '      ENDIF'

dbskip()
enddo

tek_red++
@ tek_red, 0 say '   ENDIF'
tek_red++

tek_red++
@ tek_red, 0 say 'RETURN 0'

tek_red++
@ tek_red, 0 say '*:---------------------------------------------*'
tek_red++
@ tek_red, 0 say 'FUNCTION Query1Rec_' + _nnn + '()'
tek_red++

tek_red++
@ tek_red, 0 say '   PreQuery1Rec_' + _nnn + '()'
tek_red++

tek_red++
@ tek_red, 0 say '   SET FILTER TO ' + chr(38) + '_qry_exp'
tek_red++
@ tek_red, 0 say '   dbGoTop()'
tek_red++

tek_red++
@ tek_red, 0 SAY '   IF ! EMPTY( _qry_exp )'
tek_red++
@ tek_red, 0 SAY '      COUNT TO found_rec FOR &' + '_qry_exp'
tek_red++
@ tek_red, 0 SAY '      dbGotop()'
tek_red++

tek_red++
@ tek_red, 0 SAY '      IF found_rec = 0'
tek_red++
@ tek_red, 0 SAY '         MD_Form_' + _nn + '.Statusbar.Item(1) := "Not found!"'
tek_red++
@ tek_red, 0 SAY '      ELSE'
tek_red++
@ tek_red, 0 SAY '         MD_Form_' + _nn + '.Statusbar.Item(1) := "Found " + ALLTRIM(STR(found_rec)) + " record(s)!"'
tek_red++
@ tek_red, 0 SAY '      ENDIF'
tek_red++
@ tek_red, 0 SAY '   ENDIF'

tek_red++
@ tek_red, 0 SAY '   RefreshWin_' + _nnn + '(1)'
tek_red++
@ tek_red, 0 SAY '   Cancel1Edit_' + _nnn + '()'
tek_red++

tek_red++
@ tek_red, 0 say 'RETURN 0'
tek_red++
@ tek_red, 0 say '*:---------------------------------------------*'
tek_red++
@ tek_red, 0 say 'FUNCTION PreQuery1Rec_' + _nnn + '()'
tek_red++

tek_red++
@ tek_red, 0 say '_qry_exp := "' + _set_qry + '"'
tek_red++
@ tek_red, 0 say '_ima_filter := .T.'
tek_red++

select 4
dbgotop()
do while .not. eof()

   if block != 1
      dbskip()
      loop
   endif

   if !fldatr6
      dbskip()
      loop
   endif

_mname = '.m' + upper(alltrim(fldname))
_fname = upper(alltrim(fldname))

do case
   case fldtype = 'N'

   tek_red++
   @ tek_red, 0 say 'IF ! EMPTY ( Mas_Form_' + _nn + _mname + '.Value )     // '  + _fname
   tek_red++
   @ tek_red, 0 say '   IF _ima_filter'
   tek_red++
   @ tek_red, 0 say '      _qry_exp = _qry_exp + ' + '" .AND. "'
   tek_red++
   @ tek_red, 0 say '   ENDIF'
   tek_red++
   @ tek_red, 0 say '      _qry_exp = _qry_exp + ' + '"' + _fname + ' = " + STR( Mas_Form_' + _nn + _mname + '.Value )'
   tek_red++
   @ tek_red, 0 say '      _ima_filter := .T.'
   tek_red++
   @ tek_red, 0 say 'ENDIF'
   tek_red++
 
   case fldtype = 'C'

   tek_red++
   @ tek_red, 0 say 'IF ! EMPTY ( Mas_Form_' + _nn + _mname + '.Value )     // '  + _fname
   tek_red++
   @ tek_red, 0 say '   IF _ima_filter'
   tek_red++
   @ tek_red, 0 say '      _qry_exp = _qry_exp + ' + '" .AND. "'
   tek_red++
   @ tek_red, 0 say '   ENDIF'
   tek_red++
   @ tek_red, 0 say '      _qry_exp = _qry_exp + ' + '"' + _fname + ' = " + chr(34) + Mas_Form_' + _nn + _mname + '.Value + chr(34)'
   tek_red++
   @ tek_red, 0 say '      _ima_filter := .T.'
   tek_red++
   @ tek_red, 0 say 'ENDIF'
   tek_red++

   case fldtype = 'D'

   tek_red++
   @ tek_red, 0 say 'IF ! EMPTY ( Mas_Form_' + _nn + _mname + '.Value )     // '  + _fname
   tek_red++
   @ tek_red, 0 say '   IF _ima_filter'
   tek_red++
   @ tek_red, 0 say '      _qry_exp = _qry_exp + ' + '" .AND. "'
   tek_red++
   @ tek_red, 0 say '   ENDIF'
   tek_red++
   @ tek_red, 0 say '      _qry_exp = _qry_exp + ' + '"' + _fname + ' = " + "CTOD(" + chr(34) + DTOC(Mas_Form_' + _nn + _mname + '.Value) + chr(34) + ")"' 
   tek_red++
   @ tek_red, 0 say '      _ima_filter := .T.'
   tek_red++
   @ tek_red, 0 say 'ENDIF'
   tek_red++

endcase

dbskip()
enddo

tek_red++
@ tek_red, 0 say 'RETURN 0'
tek_red++
@ tek_red, 0 say '*:---------------------------------------------*'

tek_red++
@ tek_red, 0 say 'FUNCTION Delete1Rec_' + _nn + ' ()'
tek_red++

select 1
tek_red++
@ tek_red, 0 say '   SELECT ' + dbfname
tek_red++
@ tek_red, 0 say '   GOTO _rec_no'
tek_red++

tek_red++
@ tek_red, 0 say '   IF MsgYesNo( "Are you sure do you want delete record?" )'
tek_red++

select 5
dbgotop()
do while .not. eof()

_len = len(alltrim(field1))
_space = space ( 10 - _len)

tek_red++
@ tek_red, 0 say '      ' + alltrim(dbf1) + '->' + alltrim(field1) + _space + ' := 0'

dbskip()
enddo

tek_red++
@ tek_red, 0 say '      DBCOMMIT()'
tek_red++
@ tek_red, 0 say '      DBGOTOP()'
tek_red++
@ tek_red, 0 say '      RefreshWin_' + _nnn + '()'
tek_red++
@ tek_red, 0 say '      MD_Form_' + _nn + '.Browse_' + _nn + '.Refresh'
tek_red++

tek_red++
@ tek_red, 0 say '   ENDIF'
tek_red++
tek_red++
@ tek_red, 0 say 'RETURN 0'
tek_red++
@ tek_red, 0 say '*:----------------------------------------------------*'
tek_red++
@ tek_red, 0 say 'FUNCTION Save1Record_' + _nnn + ' ()'
tek_red++

tek_red++
@ tek_red, 0 say '   IF _action = "N"'
tek_red++
@ tek_red, 0 say '      SEEK 0'
tek_red++
@ tek_red, 0 say '      IF !FOUND()'
tek_red++
@ tek_red, 0 say '         DBAPPEND()'
tek_red++
@ tek_red, 0 say '      ENDIF'
tek_red++
@ tek_red, 0 say '   ENDIF'
tek_red++

select 4
dbgotop()
do while .not. eof()

if block != 1
   dbskip()
   loop
endif

if dbfname = '$'
   dbskip()
   loop
endif

_len = len(Alltrim(fldname))
_space = space ( 12 - _len )

tek_red++
@ tek_red, 0 say '   ' + alltrim(dbfname) + '->' + alltrim(fldname) + _space + ' :=  Mas_Form_' + _nn + '.m' + alltrim(FLDNAME) + '.Value'

dbskip()
enddo

tek_red++
@ tek_red, 0 say '   DBUNLOCK()'
tek_red++
@ tek_red, 0 say '   DBCOMMIT()'
tek_red++

tek_red++
@ tek_red, 0 say '   MD_Form_' + _nn + '.Browse_' + _nn + '.Refresh'
tek_red++
@ tek_red, 0 say '   RefreshWin_' + _nnn + '()'
tek_red++
@ tek_red, 0 say '   Cancel1Edit_' + _nnn + '()'
tek_red++

tek_red++
@ tek_red, 0 say 'RETURN 0'

tek_red++
@ tek_red, 0 say '*:---------------------------------------------*'

tek_red++
@ tek_red, 0 say 'FUNCTION Cancel1Edit_' + _nnn + ' ()'
tek_red++

tek_red++
@ tek_red, 0 say '   Mas_Form_' + _nn + '.Release'
tek_red++

tek_red++
@ tek_red, 0 say 'RETURN 0'

tek_red++
@ tek_red, 0 say '*:*********************************************'
tek_red++
@ tek_red, 0 say '*                                             *'
tek_red++
@ tek_red, 0 say '* detail block                                *'
tek_red++
@ tek_red, 0 say '*                                             *'
tek_red++
@ tek_red, 0 say '*:*********************************************'
tek_red++
@ tek_red, 0 say 'FUNCTION Det_Edit_' + _nn + '( _do_it  )'
tek_red++

tek_red++
@ tek_red, 0 say '   PRIVATE _action := _do_it, i := MD_Form_' + _nn + '.MD_Grid_' + _nn + '.Value , _rec_no := 0'
tek_red++

tek_red++
@ tek_red, 0 say '      IF _action = "D" .and. i = 0'
tek_red++
@ tek_red, 0 say '         MsgInfo( "First SELECT record !" )'
tek_red++
@ tek_red, 0 say '         RETURN'
tek_red++
@ tek_red, 0 say '      ENDIF'
tek_red++

tek_red++
@ tek_red, 0 say '      IF _action = "E" .and. i = 0'
tek_red++
@ tek_red, 0 say '         MsgInfo( "First SELECT record !" )'
tek_red++
@ tek_red, 0 say '         RETURN'
tek_red++
@ tek_red, 0 say '      ENDIF'
tek_red++

if _statfld > 0
select 1
tek_red++
@ tek_red, 0 say '      SELECT ' + alltrim(dbfname)
tek_red++
@ tek_red, 0 say '      IF status = "K" '
tek_red++
@ tek_red, 0 say '         MsgInfo( "Record LOCKED, no change!" )'
tek_red++
@ tek_red, 0 say '         RETURN'
tek_red++
@ tek_red, 0 say '      ENDIF'
tek_red++

endif

tek_red++
@ tek_red, 0 say '      IF _action != "N"'
tek_red++
@ tek_red, 0 say '         _rec_no = val(aGrid[i][1])  // recno() '
// tek_red++
// @ tek_red, 0 say '         RETURN'
tek_red++
@ tek_red, 0 say '      ENDIF'
tek_red++

tek_red++
@ tek_red, 0 say '      IF _action = "D"'
tek_red++
@ tek_red, 0 say '         Delete2Rec_' + _nn + '()'
tek_red++
@ tek_red, 0 say '         RETURN'
tek_red++
@ tek_red, 0 say '      ENDIF'
tek_red++

tek_red++
@ tek_red, 0 say '   DEFINE WINDOW Det_Form_' + _nn + ' ;'
tek_red++
@ tek_red, 0 say '      AT 0,0 ;'
tek_red++
@ tek_red, 0 say '      WIDTH 600 ;'
tek_red++
@ tek_red, 0 say '      HEIGHT 700 ;'
tek_red++
@ tek_red, 0 say '      TITLE "Edit Detail Record" ;'
tek_red++
@ tek_red, 0 say '      MODAL ; '
tek_red++
@ tek_red, 0 say '      ON RELEASE RefreshWin_' + _nnn + '()'
tek_red++

tek_red++
@ tek_red, 0 say '      ON KEY ESCAPE ACTION Det_Form_' + _nn + '.Release'
tek_red++

tek_red++
@ tek_red, 0 say '      Paint2Record_' + _nnn + '()'
tek_red++
@ tek_red, 0 say '      Disable2Record_' + _nnn + '()'
tek_red++
@ tek_red, 0 say '      Load2Data_' + _nnn + '()'
tek_red++
@ tek_red, 0 say '      Enable2Record_' + _nnn + '()'
tek_red++


tek_red++
@ tek_red, 0 say '   @ 580, 50 BUTTON SAVE_' + _nnn + '; '
tek_red++
@ tek_red, 0 say '      CAPTION "Save" ; '
tek_red++
@ tek_red, 0 say '      PICTURE "frm_ok.bmp" LEFT ;'
tek_red++
@ tek_red, 0 say '      ACTION Save2Record_' + _nnn + '() ;'
tek_red++
@ tek_red, 0 say '      WIDTH 100 ;'
tek_red++
@ tek_red, 0 say '      HEIGHT 40'
tek_red++

tek_red++
@ tek_red, 0 say '   @ 580, 160 BUTTON CANCEL_' + _nnn + '; '
tek_red++
@ tek_red, 0 say '      CAPTION "Cancel" ; '
tek_red++
@ tek_red, 0 say '      PICTURE "frm_cancel.bmp" LEFT ;'
tek_red++
@ tek_red, 0 say '      ACTION Cancel2Edit_' + _nnn + '() ;'
tek_red++
@ tek_red, 0 say '      WIDTH 100 ;'
tek_red++
@ tek_red, 0 say '      HEIGHT 40'
tek_red++

tek_red++
@ tek_red, 0 say '   END WINDOW'
tek_red++

tek_red++
@ tek_red, 0 say '   CENTER WINDOW Det_Form_' + _nn
tek_red++

tek_red++
@ tek_red, 0 say '   ACTIVATE WINDOW Det_Form_' + _nn
tek_red++

tek_red++
@ tek_red, 0 say 'RETURN'

tek_red++
@ tek_red, 0 say '*:---------------------------------------------*'
tek_red++
@ tek_red, 0 say 'FUNCTION Disable2Record_' + _nnn + ' ()'
tek_red++

select 4
dbgotop()
do while .not. eof()

if block != 2
   dbskip()
   loop
endif

_len = len(alltrim(fldname))
_space = space ( 12 - _len )

_tip = '.m'
if dbfname = '$'
   _tip = '.d'
endif

tek_red++
@ tek_red, 0 say '   Det_Form_' + _nn + _tip + alltrim(fldname) + '.Enabled'  + _space + ' := .F.'

dbskip()
enddo
tek_red++

tek_red++
@ tek_red, 0 say 'RETURN 0'
tek_red++
@ tek_red, 0 say '*:---------------------------------------------*'

tek_red++
@ tek_red, 0 say 'FUNCTION Enable2Record_' + _nnn + ' ()'
tek_red++

select 4
dbgotop()
do while .not. eof()

if block != 2
   dbskip()
   loop
endif

if dbfname = '$'
   dbskip()
   loop
endif

_len = len(alltrim(fldname))
_space = space ( 12 - _len )
if fldatr4
   _set = '.T.'
else
   _set = '.F.'
endif

tek_red++
@ tek_red, 0 say '   Det_Form_' + _nn + '.m' + alltrim(fldname) + '.Enabled'  + _space + ' := ' + _set

dbskip()
enddo
tek_red++

tek_red++
@ tek_red, 0 say 'RETURN 0'
tek_red++
@ tek_red, 0 say '*:---------------------------------------------*'
tek_red++
@ tek_red, 0 say 'FUNCTION Paint2Record_' + _nnn + ' ()'
tek_red++

*** label 

select 4
dbgotop()
do while .not. eof()

if block != 2
   dbskip()
   loop
endif

if dbfname = '$'
   dbskip()
   loop
endif

_len = len(alltrim(fldname))
_space = space ( 12 - _len )

_red = fldrow

if !fldatr4
   _red = 999
endif

tek_red++
*@ tek_red, 0 say '   @ ' + str(_red,4) + ',  20 LABEL l2' + alltrim(fldname) + _space + ' VALUE "' + alltrim(fldlabel) + '"'
@ tek_red, 0 say '   @ ' + alltrim(str(_red)) + ',  20 LABEL l2' + alltrim(fldname) + _space + ' VALUE "' + alltrim(fldlabel) + '"'

dbskip()
enddo
tek_red++

*** textbox

select 4
dbgotop()
do while .not. eof()

if block != 2
   dbskip()
   loop
endif

_widt = ''
_mask = ''
_format = ''
_valid = ''
_col = fldcol	
_fldlen = fldlen

if _fldlen < 5
   _fldlen++
endif

if fldtype = 'N'
   _widt = ' WIDTH ' + alltrim(str(_fldlen * 10))
   _mask = ' NUMERIC '
   _format = ' INPUTMASK "' + alltrim(fldpict) + '"'
endif

if fldtype = 'D'
   _widt = ''
   _mask = ' DATE '
   _format = ''
endif

if fldtype = 'C'
   _widt = ' WIDTH ' + alltrim(str(_fldlen * 10))
   _mask = ''
   _pict =  strtran(fldpict,'X','!')
   _format = ' UPPERCASE' // INPUTMASK "' + alltrim(_pict) + '"'
endif

_len = len(alltrim(fldname))
_space = space ( 12 - _len )
_tip = 'm'

if dbfname = '$'
   _tip = 'd'
   _format = ''
   _col = fldcol
endif

if fldatr8
   _valid = ' on enter valid_' + _nn + '_B_' + alltrim(str(fldseq)) + '( "E" ) '
   _valid = _valid + ' on lostfocus valid_' + _nn + '_B_' + alltrim(str(fldseq)) + '( "F" ) '
endif

_red = fldrow

if !fldatr4 .and. !fldatr7
   _red = 999
endif

tek_red++
*@ tek_red, 0 say '   @ ' + str(_red,4) + ',  ' + str(_col,3) + ' TEXTBOX ' + _tip + + alltrim(fldname) + _space + _widt + _mask + _format + _valid
@ tek_red, 0 say '   @ ' + alltrim(str(_red)) + ',  ' + str(_col,3) + ' TEXTBOX ' + _tip + + alltrim(fldname) + _space + _widt + _mask + _format + _valid

dbskip()
enddo
tek_red++

tek_red++
@ tek_red, 0 say 'RETURN 0'

tek_red++
@ tek_red, 0 say '*:---------------------------------------------*'
tek_red++
@ tek_red, 0 say 'FUNCTION Load2Data_' + _nnn + ' ()'
tek_red++

select 1
tek_red++
@ tek_red, 0 say '   SELECT ' + dbfname2
tek_red++

_dbfname2 := dbfname2

tek_red++
@ tek_red, 0 say '   IF _action = "N"'

select 4
dbgotop()
do while .not. eof()

if block != 2
   dbskip()
   loop
endif

if dbfname = '$'
   dbskip()
   loop
endif

_def = alltrim(flddef)
_fld = alltrim(fldname)

if fldtype = 'C'
   _def = chr(34) + _def + chr(34)
endif

select 5
locate for field2 = _fld
if found()
   _def = alltrim(dbf1) + '->' + alltrim(field1)
endif

select 4

_len = len(alltrim(fldname))
_space = space ( 12 - _len )

tek_red++
@ tek_red, 0 say '      Det_Form_' + _nn + '.m' + alltrim(fldname) + '.Value' + _space + ' := ' + _def

dbskip()
enddo
tek_red++

tek_red++
@ tek_red, 0 say '   ELSE'

tek_red++
@ tek_red, 0 say '      GOTO _rec_no'

select 4
dbgotop()
do while .not. eof()

if block != 2
   dbskip()
   loop
endif

if dbfname = '$'
   dbskip()
   loop
endif

_len = len(alltrim(fldname))
_space = space ( 12 - _len )

tek_red++
@ tek_red, 0 say '      Det_Form_' + _nn + '.m' + alltrim(fldname) + '.Value' + _space + ' := ' + alltrim(dbfname) + '->' + alltrim(fldname)

dbskip()
enddo

select 4
dbgotop()
do while .not. eof()

if block != 2
   dbskip()
   loop
endif

if !fldatr8
   dbskip()
   loop
endif

tek_red++
@ tek_red, 0 say '      SELECT ' + alltrim(valid_dbf)
tek_red++
@ tek_red, 0 say '      SEEK Det_Form_' + _nn + '.m' + alltrim(fldname) + '.Value'
tek_red++
@ tek_red, 0 say '      IF FOUND()'
tek_red++
@ tek_red, 0 say '         Det_Form_' + _nn + '.d' + alltrim(valid_dsp) + '.Value := ' + alltrim(valid_dbf) + '->' + alltrim(valid_fld)
tek_red++
@ tek_red, 0 say '         SELECT ' + _dbfname2
tek_red++
@ tek_red, 0 say '      ENDIF'

dbskip()
enddo

tek_red++
@ tek_red, 0 say '   ENDIF'
tek_red++

tek_red++
@ tek_red, 0 say 'RETURN 0'

tek_red++
@ tek_red, 0 say '*:---------------------------------------------*'
tek_red++
@ tek_red, 0 say 'FUNCTION Delete2Rec_' + _nn + ' ()'
tek_red++

select 1
tek_red++
@ tek_red, 0 say '   SELECT ' + dbfname2
tek_red++
@ tek_red, 0 say '   GOTO _rec_no'
tek_red++

tek_red++
@ tek_red, 0 say '   IF MsgYesNo( "Are you sure do you want delete record?" )' 
tek_red++

select 5
dbgotop()
do while .not. eof()

_len = len(alltrim(field2))
_space = space ( 10 - _len)

tek_red++
@ tek_red, 0 say '      ' + alltrim(dbf2) + '->' + alltrim(field2) + _space + ' := 0'

dbskip()
enddo

tek_red++
@ tek_red, 0 say '      DBCOMMIT()' 
tek_red++
@ tek_red, 0 say '      RefreshWin_' + _nnn + '()'
tek_red++

tek_red++
@ tek_red, 0 say '   ENDIF' 
tek_red++

tek_red++
@ tek_red, 0 say 'RETURN 0'
tek_red++
@ tek_red, 0 say '*:---------------------------------------------*'
tek_red++
@ tek_red, 0 say 'FUNCTION Save2Record_' + _nnn + ' ()'
tek_red++

tek_red++
@ tek_red, 0 say '   IF _action = "N"'
tek_red++
@ tek_red, 0 say '      SEEK 0'
tek_red++
@ tek_red, 0 say '      IF !FOUND()'
tek_red++
@ tek_red, 0 say '         DBAPPEND()'
tek_red++
@ tek_red, 0 say '      ENDIF'
tek_red++
@ tek_red, 0 say '   ENDIF'
tek_red++

select 4
dbgotop()
do while .not. eof()

if block != 2
   dbskip()
   loop
endif

if dbfname = '$'
   dbskip()
   loop
endif

tek_red++
@ tek_red, 0 say '   ' + alltrim(dbfname) +  '->' + fldname + ' :=  Det_Form_' + _nn + '.m' + alltrim(fldname) + '.Value'

dbskip()
enddo
tek_red++

tek_red++
@ tek_red, 0 say '   RefreshWin_' + _nnn + '()'
tek_red++
@ tek_red, 0 say '   Cancel2Edit_' + _nnn + '()'
tek_red++

tek_red++
@ tek_red, 0 say 'RETURN 0'
tek_red++
@ tek_red, 0 say '*:---------------------------------------------*'
tek_red++
@ tek_red, 0 say 'FUNCTION Cancel2Edit_' + _nnn + ' ()'
tek_red++

tek_red++
@ tek_red, 0 say '   Det_Form_' + _nn + '.Release'
tek_red++

tek_red++
@ tek_red, 0 SAY 'RETURN 0'
tek_red++
@ tek_red, 0 say '*:---------------------------------------------*'
tek_red++
@ tek_red, 0 say 'FUNCTION PrintData_' + _nnn + ' ()'
tek_red++

tek_red++
@ tek_red, 0 say '   msginfo("Under construction")'
tek_red++

tek_red++
@ tek_red, 0 say '   *_recno := MD_Form_' + _nn + '.Browse_' + _nn + '.Value'
tek_red++
@ tek_red, 0 say '   *GO _recno '
tek_red++
tek_red++
@ tek_red, 0 say '   *_par1 := <fileld1>'
tek_red++
@ tek_red, 0 say '   *_par2 := <fileld2>'
tek_red++
@ tek_red, 0 say '   *_par3 := <fileld3>'
tek_red++
tek_red++
@ tek_red, 0 say '   *dbcloseall()'
tek_red++
tek_red++
@ tek_red, 0 say '   *MD_Form_' + _nn + '.Release'
tek_red++
tek_red++
@ tek_red, 0 say '   *call_report( _par1, _par2, _par3 )'
tek_red++
tek_red++
@ tek_red, 0 SAY 'RETURN 0'
tek_red++

@ tek_red, 0 SAY '*** end of program ***'
tek_red++

****************************************************
*
* valid funkcije
*
****************************************************

select 4
dbgotop()
do while .not. eof()

   if block = 1
      _tip = 'A'
      _form = 'Mas_Form_'
   else
      _tip = 'B'
      _form = 'Det_Form_'
   endif

   _seq = alltrim(str(fldseq))
   _nnv = _nn + _tip + _seq

   if fldatr8
 
      tek_red++
      @ tek_red, 0 say '*:***********************************************************'
      tek_red++

      @ tek_red, 0 say 'FUNCTION valid_' + _nn + '_' + _tip + '_' + _seq + ' ( _p1 )'
      tek_red++
   
   if _tip = 'A'   
   
      tek_red++
      @ tek_red, 0 say 'IF _action = "F"'
      tek_red++
      @ tek_red, 0 say '   RETURN .T.'
      tek_red++
      @ tek_red, 0 say 'ENDIF'
      tek_red++
      
   ENDIF
   
      tek_red++
      @ tek_red, 0 say 'SELECT ' + lower(valid_dbf)
      tek_red++
      @ tek_red, 0 say 'SEEK ' + _form + _nn + '.m' + alltrim(upper(fldname)) + '.Value'
      tek_red++
      @ tek_red, 0 say 'IF FOUND()'
      tek_red++
      @ tek_red, 0 say '   ' + _form + _nn + '.d' + alltrim(upper(valid_dsp)) + '.Value := ' + upper(valid_fld)
      tek_red++
      @ tek_red, 0 say '   SELECT ' + lower(dbfname)
      tek_red++
      @ tek_red, 0 say '   RETURN .T.'
      tek_red++
      @ tek_red, 0 say 'ELSE'
      tek_red++
      @ tek_red, 0 say '   IF _p1 = "E"'
      tek_red++
      @ tek_red, 0 say '      ' + _form + _nn + '.m' + alltrim(upper(fldname)) + '.Value := lovs_func("' +  alltrim(valid_dbf) + '", "' + alltrim(valid_key) + '", "' + alltrim(valid_fld) + '" )'
      tek_red++
	  
	  tek_red++
      @ tek_red, 0 say '      dbcloseall()'
      tek_red++
      @ tek_red, 0 say '      open_' + _nnn + '()'
      tek_red++
      	  
	  tek_red++
      @ tek_red, 0 say '      SELECT ' + lower(dbfname)
      tek_red++
      @ tek_red, 0 say '      RETURN .T.'
      tek_red++
      @ tek_red, 0 say '   ENDIF'
      tek_red++
      @ tek_red, 0 say 'ENDIF'
      tek_red++

      tek_red++
      @ tek_red, 0 say 'RETURN .F.'
      tek_red++
      
   endif
   select 4
   dbskip()
enddo

@ tek_red, 0 SAY '*** end of valids ***'
tek_red++

set printer to 
set device to screen
setprc(0,0)

dbcloseall()

MsgInfo ( 'Generate ' + _fmd_prg + ' !')

FmdGenForm.Release

RETURN
